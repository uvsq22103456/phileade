<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>J & P</title>
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="J & P">

<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --sage: #5BA08A;
  --sage-light: #A8D5C5;
  --terracotta: #6B9FD4;
  --cream: #F0FAF6;
  --ink: #2D3F35;
  --ink-soft: #4A6558;
  --muted: #8AADA0;
  --white: #FFFFFF;
  --jade-color: #5BA08A;
  --phileas-color: #6B9FD4;
}

* { box-sizing: border-box; margin: 0; padding: 0; }

body {
  font-family: 'DM Sans', sans-serif;
  background: var(--cream);
  color: var(--ink);
  padding-bottom: 130px;
  padding-top: env(safe-area-inset-top);
  min-height: 100vh;
  -webkit-tap-highlight-color: transparent;
}

body::before {
  content: '';
  position: fixed; top: 0; left: 0; right: 0; height: 280px;
  background: linear-gradient(160deg, #d8f2ea 0%, #f0faf6 60%);
  z-index: -1;
  pointer-events: none;
}

/* LOGIN */
#login-screen {
  position: fixed; inset: 0; z-index: 1000;
  background: var(--ink);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  padding: 40px 24px;
}
.login-title {
  font-family: 'DM Serif Display', serif;
  font-size: 48px; color: var(--cream);
  letter-spacing: -1px; margin-bottom: 8px;
  text-align: center;
}
.login-sub { color: var(--muted); font-size: 13px; letter-spacing: 3px; text-transform: uppercase; margin-bottom: 60px; text-align: center; }
.login-cards { display: flex; gap: 20px; }
.login-card {
  width: 140px; height: 180px;
  border-radius: 24px;
  display: flex; flex-direction: column; align-items: center; justify-content: flex-end;
  padding-bottom: 20px; cursor: pointer;
  transition: transform 0.2s;
  position: relative; overflow: hidden;
}
.login-card:active { transform: scale(0.95); }
.login-card-jade { background: linear-gradient(160deg, #7BC4AF, #4a9e85); }
.login-card-phileas { background: linear-gradient(160deg, #85B8E8, #4a8fc7); }
.login-card-emoji { font-size: 52px; position: absolute; top: 22px; }
.login-card-name { color: white; font-weight: 700; font-size: 13px; letter-spacing: 2px; text-transform: uppercase; }

/* HEADER */
.app-header {
  padding: 20px 20px 10px;
  display: flex; justify-content: space-between; align-items: flex-end;
}
.app-header h1 { font-family: 'DM Serif Display', serif; font-size: 28px; color: var(--ink); letter-spacing: -0.5px; }
.app-header .user-tag {
  background: var(--white);
  border-radius: 20px;
  padding: 6px 14px;
  font-size: 11px; font-weight: 600;
  color: var(--muted);
  display: flex; align-items: center; gap: 6px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.user-dot { width: 8px; height: 8px; border-radius: 50%; }

/* PAGES */
.page { display: none; padding: 16px 16px 0; animation: fadeUp 0.3s ease; }
.page.active { display: block; }
@keyframes fadeUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

/* CARDS */
.card {
  background: var(--white);
  border-radius: 20px;
  padding: 18px;
  margin-bottom: 14px;
  box-shadow: 0 2px 12px rgba(0,0,0,0.04);
  border: 1px solid rgba(0,0,0,0.03);
}
.card-dark {
  background: var(--ink);
  color: var(--cream);
  border: none;
}

/* SECTION TITLE */
.s-title {
  font-family: 'DM Serif Display', serif;
  font-size: 22px; color: var(--ink);
  margin-bottom: 14px; margin-left: 2px;
}
.s-title-sm {
  font-size: 10px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 2px; color: var(--muted);
  margin-bottom: 10px;
}

/* INPUTS */
.inp {
  width: 100%;
  background: #EAF5F0;
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 12px;
  padding: 12px 14px;
  font-family: 'DM Sans', sans-serif;
  font-size: 13px; font-weight: 500;
  outline: none; margin-bottom: 8px;
  color: var(--ink);
}
.inp::placeholder { color: var(--muted); }

.btn-main {
  width: 100%;
  background: var(--ink);
  color: var(--cream);
  padding: 14px;
  border-radius: 14px;
  font-weight: 700; font-size: 12px;
  text-transform: uppercase; letter-spacing: 1.5px;
  border: none; cursor: pointer;
  transition: opacity 0.2s;
}
.btn-main:active { opacity: 0.8; }
.btn-sage { background: var(--sage); }
.btn-terra { background: var(--terracotta); }

/* NAV */
.nav-bar {
  position: fixed; bottom: 16px; left: 12px; right: 12px;
  background: var(--ink);
  height: 68px; border-radius: 34px;
  display: flex; justify-content: space-around; align-items: center;
  padding: 0 8px;
  box-shadow: 0 10px 40px rgba(28,28,30,0.25);
  z-index: 999;
}
.nav-btn {
  color: rgba(255,255,255,0.3);
  font-size: 19px;
  width: 48px; height: 48px;
  display: flex; align-items: center; justify-content: center;
  border-radius: 50%;
  transition: all 0.2s;
  border: none; background: none; cursor: pointer;
}
.nav-btn.active {
  color: var(--ink);
  background: var(--cream);
  transform: scale(1.05);
}

/* MOOD */
.mood-btn {
  font-size: 22px;
  background: none; border: none;
  opacity: 0.4;
  transition: all 0.2s;
  cursor: pointer;
}
.mood-btn.selected { transform: scale(1.3); opacity: 1; filter: none; }

/* CALENDAR */
.cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 3px; margin-top: 12px; }
.cal-day {
  aspect-ratio: 1;
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  border-radius: 10px;
  font-size: 13px; font-weight: 600;
  color: var(--muted);
  background: transparent;
  position: relative; cursor: pointer;
  transition: all 0.15s;
}
.cal-day:active { transform: scale(0.9); }
.cal-day.today { background: var(--ink); color: var(--cream); box-shadow: 0 4px 12px rgba(28,28,30,0.2); }
.cal-day.has-event::after { content: ''; position: absolute; bottom: 3px; width: 4px; height: 4px; background: var(--sage); border-radius: 50%; }
.cal-day.today.has-event::after { background: var(--sage-light); }

/* ACTIVITIES */
.activity-card {
  background: var(--white);
  border-radius: 16px;
  padding: 14px 16px;
  margin-bottom: 10px;
  display: flex; align-items: center; gap: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  border: 1px solid rgba(0,0,0,0.04);
  transition: all 0.2s;
}
.activity-card.done { opacity: 0.65; }
.act-icon {
  width: 44px; height: 44px;
  border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; flex-shrink: 0;
  background: #F5F3F0;
}
.act-info { flex: 1; min-width: 0; }
.act-name { font-weight: 700; font-size: 13px; color: var(--ink); }
.act-loc { font-size: 11px; color: var(--muted); font-weight: 500; margin-top: 1px; }
.act-done-badge { font-size: 10px; font-weight: 700; color: var(--sage); background: #e8f0e9; padding: 3px 8px; border-radius: 20px; }

/* STARS */
.stars { display: flex; gap: 2px; }
.star { font-size: 16px; cursor: pointer; transition: transform 0.1s; }
.star:active { transform: scale(1.3); }

/* VACANCES */
.vac-card {
  background: var(--white);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 10px;
  border: 1px solid rgba(0,0,0,0.04);
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.priority-badge {
  display: inline-flex; align-items: center; justify-content: center;
  width: 28px; height: 28px;
  border-radius: 50%;
  font-weight: 800; font-size: 12px;
  background: var(--ink); color: var(--cream);
  flex-shrink: 0;
}

/* VOYAGE BUDGET */
.trip-line {
  display: flex; justify-content: space-between; align-items: center;
  padding: 10px 0;
  border-bottom: 1px solid #F0EDE9;
}
.trip-total {
  background: linear-gradient(135deg, var(--sage), #4a7a52);
  border-radius: 16px; padding: 16px;
  color: white; margin-top: 12px;
  display: flex; justify-content: space-between; align-items: center;
}

/* JOURNAL */
.journal-entry {
  background: var(--white);
  border-radius: 16px;
  padding: 16px;
  margin-bottom: 10px;
  border-left: 3px solid var(--sage-light);
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}
.journal-mine { border-left-color: var(--sage); }
.journal-theirs { border-left-color: var(--terracotta); }

/* CHAT */
.msg-bubble {
  max-width: 80%;
  padding: 10px 14px;
  border-radius: 18px;
  font-size: 13px; font-weight: 500;
  line-height: 1.4;
  margin-bottom: 6px;
}
.msg-mine { background: var(--ink); color: var(--cream); border-bottom-right-radius: 4px; margin-left: auto; }
.msg-theirs { background: var(--white); color: var(--ink); border-bottom-left-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }

/* CAGNOTTE */
.cagnotte-display {
  font-family: 'DM Serif Display', serif;
  font-size: 42px; color: var(--cream);
  letter-spacing: -1px;
}

/* WISHLIST */
.wish-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.wish-item {
  background: var(--white);
  border-radius: 16px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
  border: 1px solid rgba(0,0,0,0.04);
  position: relative;
}
.wish-img { height: 110px; background-size: cover; background-position: center; background-color: #F5F3F0; }
.wish-body { padding: 10px; }
.wish-name { font-weight: 700; font-size: 12px; color: var(--ink); margin-bottom: 3px; }
.wish-price { font-size: 11px; font-weight: 700; color: var(--terracotta); }
.wish-tag-jade { background: #D8F2EA; color: var(--sage); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; padding: 2px 7px; border-radius: 20px; display: inline-block; }
.wish-tag-phileas { background: #D6EAFA; color: var(--terracotta); font-size: 9px; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; padding: 2px 7px; border-radius: 20px; display: inline-block; }

/* CHIP FILTERS */
.chips { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 6px; margin-bottom: 12px; }
.chips::-webkit-scrollbar { display: none; }
.chip {
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 12px; font-weight: 600;
  white-space: nowrap;
  background: var(--white);
  color: var(--muted);
  border: 1px solid rgba(0,0,0,0.06);
  cursor: pointer; transition: all 0.15s;
  box-shadow: 0 2px 6px rgba(0,0,0,0.04);
}
.chip.active-chip { background: var(--ink); color: var(--cream); border-color: var(--ink); }

/* DRAG */
.dragging { opacity: 0.5; }

/* POLL */
.poll-opt {
  flex: 1; position: relative; cursor: pointer;
  border-radius: 14px; overflow: hidden;
  transition: transform 0.15s;
}
.poll-opt:active { transform: scale(0.96); }

.hidden { display: none !important; }
select.inp { color: var(--ink-soft); }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="login-screen" class="fixed inset-0 z-[1000] flex flex-col items-center justify-center" style="background:#1C1C1E">
  <p class="login-sub" style="margin-bottom:16px">Bienvenue dans votre espace</p>
  <h1 class="login-title">J & P</h1>
  <p class="login-sub">Qui es-tu ?</p>
  <div class="login-cards">
    <div onclick="login('jade')" class="login-card login-card-jade">
      <span class="login-card-emoji">ğŸ‘©ğŸ»â€ğŸ¦°</span>
      <span class="login-card-name">Jade</span>
    </div>
    <div onclick="login('phileas')" class="login-card login-card-phileas">
      <span class="login-card-emoji">ğŸ‘±ğŸ»â€â™‚ï¸</span>
      <span class="login-card-name">Phileas</span>
    </div>
  </div>
</div>

<!-- HEADER -->
<div class="app-header">
  <h1>J & P</h1>
  <div class="user-tag">
    <div class="user-dot" id="u-dot" style="background:var(--sage)"></div>
    <span id="u-display">...</span>
    <span onclick="logout()" style="margin-left:4px; cursor:pointer; color: #ccc">â†©</span>
  </div>
</div>

<!-- HOME -->
<div id="home" class="page active">
  <!-- Countdown -->
  <div id="countdown" class="card card-dark hidden" style="margin-bottom:14px">
    <div style="display:flex; justify-content:space-between; align-items:center">
      <div>
        <p style="font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:2px; color:rgba(248,244,238,0.5); margin-bottom:4px">Prochain Ã©vÃ¨nement</p>
        <h2 id="next-t" style="font-family:'DM Serif Display',serif; font-size:18px; color:var(--cream)">â€”</h2>
        <p id="next-d" style="font-size:11px; color:rgba(248,244,238,0.6); margin-top:3px">â€”</p>
      </div>
      <div style="text-align:center; background:rgba(255,255,255,0.08); border-radius:16px; padding:12px 18px">
        <span id="next-j" style="font-family:'DM Serif Display',serif; font-size:36px; color:var(--cream); display:block; line-height:1">0</span>
        <span style="font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:rgba(248,244,238,0.5)">jours</span>
      </div>
    </div>
  </div>

  <!-- Humeur -->
  <div class="card">
    <p class="s-title-sm">Humeur du jour</p>
    <div style="display:flex; justify-content:space-between; padding: 6px 0; margin-bottom: 16px">
      <button onclick="setMood('ğŸ¥°',this)" class="mood-btn">ğŸ¥°</button>
      <button onclick="setMood('ğŸ˜„',this)" class="mood-btn">ğŸ˜„</button>
      <button onclick="setMood('ğŸ˜Œ',this)" class="mood-btn">ğŸ˜Œ</button>
      <button onclick="setMood('ğŸ˜¶',this)" class="mood-btn">ğŸ˜¶</button>
      <button onclick="setMood('ğŸ˜’',this)" class="mood-btn">ğŸ˜’</button>
      <button onclick="setMood('ğŸ˜”',this)" class="mood-btn">ğŸ˜”</button>
      <button onclick="setMood('ğŸ« ',this)" class="mood-btn">ğŸ« </button>
    </div>
    <div style="display:flex; justify-content:space-around; background:#F8F6F2; margin:-18px; margin-top:0; padding:14px 18px; border-radius:0 0 20px 20px">
      <div style="text-align:center">
        <span style="font-size:9px; font-weight:800; text-transform:uppercase; letter-spacing:1.5px; color:var(--sage); display:block; margin-bottom:4px">Jade ğŸ‘©ğŸ»â€ğŸ¦°</span>
        <span id="m-jade" style="font-size:24px">ğŸ˜¶</span>
      </div>
      <div style="width:1px; background:rgba(0,0,0,0.06)"></div>
      <div style="text-align:center">
        <span style="font-size:9px; font-weight:800; text-transform:uppercase; letter-spacing:1.5px; color:var(--terracotta); display:block; margin-bottom:4px">Phileas ğŸ‘±ğŸ»â€â™‚ï¸</span>
        <span id="m-phileas" style="font-size:24px">ğŸ˜¶</span>
      </div>
    </div>
  </div>

  <!-- Calendrier -->
  <div class="card">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:4px">
      <h3 style="font-weight:700; font-size:14px; color:var(--ink)">Calendrier</h3>
      <span id="cal-title" style="font-size:11px; font-weight:600; color:var(--muted)">...</span>
    </div>
    <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; margin-bottom:6px">
      <span style="font-size:9px; font-weight:800; color:var(--muted)">L</span><span style="font-size:9px; font-weight:800; color:var(--muted)">M</span><span style="font-size:9px; font-weight:800; color:var(--muted)">M</span><span style="font-size:9px; font-weight:800; color:var(--muted)">J</span><span style="font-size:9px; font-weight:800; color:var(--muted)">V</span><span style="font-size:9px; font-weight:800; color:var(--muted)">S</span><span style="font-size:9px; font-weight:800; color:var(--muted)">D</span>
    </div>
    <div id="cal-grid" class="cal-grid"></div>
    <div id="evt-box" class="hidden" style="margin-top:14px; padding-top:14px; border-top:1px solid #F0EDE9">
      <p id="sel-date" style="font-size:11px; font-weight:700; color:var(--sage); margin-bottom:8px; text-transform:uppercase; letter-spacing:1px"></p>
      <div id="evt-list" style="margin-bottom:10px"></div>
      <div style="display:flex; gap:8px">
        <input type="text" id="new-evt" placeholder="Ajouter un Ã©vÃ¨nement..." class="inp" style="margin:0; flex:1">
        <button onclick="addEvt()" style="background:var(--ink); color:white; border:none; width:44px; border-radius:12px; font-size:20px; cursor:pointer">+</button>
      </div>
    </div>
  </div>
</div>

<!-- ACTIVITÃ‰S -->
<div id="activities" class="page">
  <h2 class="s-title">ActivitÃ©s & Sorties</h2>
  <div class="card" style="border-left:3px solid var(--sage)">
    <input type="text" id="act-name" placeholder="Nom du lieu ou activitÃ©..." class="inp">
    <div style="display:flex; gap:8px">
      <select id="act-cat" class="inp" style="width:40%; margin-bottom:0">
        <option value="Resto">ğŸ Resto</option>
        <option value="FastFood">ğŸ” FastFood</option>
        <option value="Bar">ğŸ¸ Bar</option>
        <option value="Expo">ğŸ–¼ Expo</option>
        <option value="Musique">ğŸµ Concert</option>
        <option value="Sport">ğŸƒ Sport</option>
        <option value="Autre">âœ¨ Autre</option>
      </select>
      <input type="text" id="act-loc" placeholder="Ville / Quartier" class="inp" style="margin-bottom:0; flex:1">
    </div>
    <button onclick="addAct()" class="btn-main" style="margin-top:8px">Ajouter Ã  la liste</button>
  </div>

  <div class="chips" id="act-chips">
    <div onclick="filterAct('all',this)" class="chip active-chip">Tout</div>
    <div onclick="filterAct('Resto',this)" class="chip">ğŸ Restos</div>
    <div onclick="filterAct('FastFood',this)" class="chip">ğŸ” FastFood</div>
    <div onclick="filterAct('Bar',this)" class="chip">ğŸ¸ Bars</div>
    <div onclick="filterAct('Expo',this)" class="chip">ğŸ–¼ Expos</div>
    <div onclick="filterAct('Musique',this)" class="chip">ğŸµ Concerts</div>
    <div onclick="filterAct('Sport',this)" class="chip">ğŸƒ Sport</div>
    <div onclick="filterAct('done',this)" class="chip">âœ… Faits</div>
  </div>

  <div id="act-list"></div>
</div>

<!-- JOURNAL -->
<div id="journal" class="page">
  <h2 class="s-title">Journal intime</h2>
  <p style="font-size:11px; color:var(--muted); margin-bottom:14px; margin-left:2px">ChacunÂ·e Ã©crit, les deux lisent ğŸ”’</p>

  <div class="card">
    <textarea id="jnl-text" class="inp" style="min-height:100px; resize:none; margin-bottom:8px" placeholder="Aujourd'hui..."></textarea>
    <button onclick="addJournal()" class="btn-main">Publier l'entrÃ©e</button>
  </div>

  <div id="jnl-list"></div>
</div>

<!-- CHAT -->
<div id="chat" class="page">
  <h2 class="s-title">Discussion</h2>
  <div id="chat-box" style="min-height:55vh; overflow-y:auto; padding-bottom:16px; display:flex; flex-direction:column; gap:4px"></div>

  <!-- Poll modal -->
  <div id="poll-modal" class="hidden card" style="margin-bottom:10px">
    <p class="s-title-sm" style="margin-bottom:10px">Nouveau sondage ğŸ“Š</p>
    <input type="text" id="pq" placeholder="Ta question ?" class="inp">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:8px">
      <div>
        <input type="text" id="poll-opt1" placeholder="Option A (texte)" class="inp" style="margin-bottom:6px">
        <label style="height:70px;background:#D8F2EA;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;font-weight:600;color:var(--sage);position:relative;overflow:hidden;border:1.5px dashed rgba(91,160,138,0.4)">
          <span id="txt-p1">ğŸ“¸ Photo (optionnel)</span>
          <input type="file" class="hidden" onchange="compress(this,'p1')">
          <div id="v-p1" style="position:absolute;inset:0;background-size:cover;background-position:center;display:none"></div>
        </label>
      </div>
      <div>
        <input type="text" id="poll-opt2" placeholder="Option B (texte)" class="inp" style="margin-bottom:6px">
        <label style="height:70px;background:#D6EAFA;border-radius:12px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:11px;font-weight:600;color:var(--terracotta);position:relative;overflow:hidden;border:1.5px dashed rgba(107,159,212,0.4)">
          <span id="txt-p2">ğŸ“¸ Photo (optionnel)</span>
          <input type="file" class="hidden" onchange="compress(this,'p2')">
          <div id="v-p2" style="position:absolute;inset:0;background-size:cover;background-position:center;display:none"></div>
        </label>
      </div>
    </div>
    <button onclick="sendPoll()" class="btn-main">Lancer le vote âœ“</button>
  </div>

  <div style="position:fixed; bottom:90px; left:12px; right:12px; z-index:50">
    <div style="display:flex; gap:8px; align-items:center; background:white; padding:8px; border-radius:30px; box-shadow:0 4px 20px rgba(0,0,0,0.1); border:1px solid rgba(0,0,0,0.04)">
      <button onclick="document.getElementById('poll-modal').classList.toggle('hidden')" style="width:40px;height:40px;border-radius:50%;background:#F5F3F0;color:var(--sage);border:none;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center">ğŸ“Š</button>
      <input type="text" id="msg" placeholder="Message..." style="flex:1;outline:none;font-family:'DM Sans',sans-serif;font-size:13px;background:transparent;border:none;color:var(--ink)">
      <button onclick="sendMsg()" style="width:40px;height:40px;border-radius:50%;background:var(--ink);color:white;border:none;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center">â¤</button>
    </div>
  </div>
</div>

<!-- VACANCES -->
<div id="vacances" class="page">
  <h2 class="s-title">Destinations rÃªvÃ©es</h2>

  <!-- Cagnotte -->
  <div class="card card-dark" style="margin-bottom:14px">
    <p style="font-size:9px; font-weight:700; text-transform:uppercase; letter-spacing:2px; color:rgba(248,244,238,0.5); margin-bottom:6px">Cagnotte voyage</p>
    <div style="display:flex; justify-content:space-between; align-items:flex-end; margin-bottom:12px">
      <span class="cagnotte-display" id="tot-save">0 â‚¬</span>
      <button onclick="editSave()" style="background:rgba(255,255,255,0.12);color:white;border:none;padding:8px 16px;border-radius:10px;font-size:12px;font-weight:700;cursor:pointer">+ / âˆ’</button>
    </div>
    <details>
      <summary style="font-size:10px; color:rgba(248,244,238,0.5); cursor:pointer; list-style:none; font-weight:600">ğŸ“œ Historique</summary>
      <div id="hist-save" style="margin-top:10px; max-height:120px; overflow-y:auto"></div>
    </details>
  </div>

  <!-- Ajouter destination -->
  <div class="card" style="border-left:3px solid var(--terracotta)">
    <p class="s-title-sm">Nouvelle destination</p>
    <input type="text" id="vac-dest" placeholder="Ex: Tokyo, Sicile, Marrakech..." class="inp">
    <div style="display:flex; gap:8px">
      <input type="number" id="vac-budget" placeholder="Budget estimÃ© â‚¬" class="inp" style="width:50%; margin-bottom:0">
      <input type="text" id="vac-period" placeholder="PÃ©riode idÃ©ale" class="inp" style="flex:1; margin-bottom:0">
    </div>
    <button onclick="addDest()" class="btn-main" style="margin-top:8px; background:var(--terracotta)">Ajouter au wishlist voyage</button>
  </div>

  <p class="s-title-sm" style="margin-left:2px; margin-top:4px">ğŸŒ Classement par prioritÃ© (glisser pour rÃ©organiser)</p>
  <div id="dest-list"></div>

  <!-- Planifier un voyage -->
  <div style="margin-top:8px; margin-bottom:8px">
    <p class="s-title-sm" style="margin-left:2px">âœˆï¸ Planifier un voyage</p>
    <div class="card" style="border-left:3px solid var(--sage)">
      <input type="text" id="trip-dest" placeholder="Destination du voyage" class="inp">
      <input type="text" id="trip-date" placeholder="Dates (ex: 15-22 mars 2025)" class="inp">
      <p style="font-size:11px; font-weight:600; color:var(--muted); margin-bottom:8px">ActivitÃ©s prÃ©vues :</p>
      <div id="trip-activities-form">
        <div class="trip-act-row" style="display:flex; gap:8px; margin-bottom:6px">
          <input type="text" placeholder="ActivitÃ©" class="inp trip-act-name" style="flex:1; margin:0">
          <input type="number" placeholder="â‚¬" class="inp trip-act-price" style="width:70px; margin:0">
        </div>
      </div>
      <button onclick="addTripLine()" style="width:100%; padding:10px; border:1.5px dashed #D0CBC4; background:transparent; border-radius:12px; font-size:12px; font-weight:600; color:var(--muted); cursor:pointer; margin:8px 0">+ Ligne d'activitÃ©</button>
      <div id="trip-total" class="trip-total hidden">
        <div>
          <p style="font-size:10px; opacity:0.7; font-weight:600; margin-bottom:2px">Budget total estimÃ©</p>
          <p style="font-family:'DM Serif Display',serif; font-size:28px" id="trip-total-amount">0 â‚¬</p>
          <p style="font-size:10px; opacity:0.7; margin-top:2px" id="trip-total-dest">â€”</p>
        </div>
        <div style="text-align:right">
          <p style="font-size:10px; opacity:0.7; font-weight:600; margin-bottom:2px">Cagnotte actuelle</p>
          <p id="trip-cagnotte" style="font-size:18px; font-weight:800">0 â‚¬</p>
          <p id="trip-diff" style="font-size:10px; opacity:0.7; margin-top:2px">â€”</p>
        </div>
      </div>
      <button onclick="calcAndSaveTrip()" class="btn-main btn-sage" style="margin-top:8px">Calculer & Sauvegarder</button>
    </div>
  </div>

  <!-- Voyages sauvegardÃ©s -->
  <p class="s-title-sm" style="margin-left:2px">ğŸ“‹ Voyages planifiÃ©s</p>
  <div id="trips-list"></div>
</div>

<!-- WISHLIST -->
<div id="wish" class="page">
  <h2 class="s-title">Wishlist</h2>
  <div class="card" style="border-left:3px solid var(--terracotta)">
    <input type="text" id="w-n" placeholder="Nom de l'objet" class="inp">
    <div style="display:flex; gap:8px">
      <input type="number" id="w-p" placeholder="Prix â‚¬" class="inp" style="width:40%; margin-bottom:0">
      <input type="text" id="w-l" placeholder="Lien (optionnel)" class="inp" style="flex:1; margin-bottom:0">
    </div>
    <label style="width:100%; padding:14px; background:#F5F3F0; border-radius:12px; display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:12px; font-weight:600; color:var(--muted); margin-top:8px; position:relative; overflow:hidden; min-height:50px; border:1.5px dashed #D0CBC4">
      <span id="txt-w">ğŸ“¸ Ajouter une photo</span>
      <input type="file" class="hidden" onchange="compress(this,'wish')">
      <div id="v-w" style="position:absolute;inset:0;background-size:cover;background-position:center;display:none;opacity:0.8"></div>
    </label>
    <button onclick="addWish()" class="btn-main" style="margin-top:8px">Ajouter Ã  la wishlist</button>
  </div>
  <div style="margin-top:4px">
    <div style="display:flex; gap:10px; margin-bottom:12px">
      <button onclick="filterWish('all')" id="wf-all" style="flex:1; padding:10px; border-radius:12px; background:var(--ink); color:white; border:none; font-weight:700; font-size:11px; cursor:pointer">Tout</button>
      <button onclick="filterWish('jade')" id="wf-jade" style="flex:1; padding:10px; border-radius:12px; background:#F5F3F0; color:var(--sage); border:none; font-weight:700; font-size:11px; cursor:pointer">ğŸŒ¿ Jade</button>
      <button onclick="filterWish('phileas')" id="wf-phileas" style="flex:1; padding:10px; border-radius:12px; background:#F5F3F0; color:var(--terracotta); border:none; font-weight:700; font-size:11px; cursor:pointer">ğŸ§­ Phileas</button>
    </div>
    <div class="wish-grid" id="w-grid"></div>
  </div>
</div>

<!-- NAV -->
<nav class="nav-bar">
  <button onclick="nav('home',this)" class="nav-btn active"><i class="fa-solid fa-house"></i></button>
  <button onclick="nav('activities',this)" class="nav-btn"><i class="fa-solid fa-map-pin"></i></button>
  <button onclick="nav('journal',this)" class="nav-btn"><i class="fa-solid fa-book-open"></i></button>
  <button onclick="nav('chat',this)" class="nav-btn"><i class="fa-solid fa-comments"></i></button>
  <button onclick="nav('vacances',this)" class="nav-btn"><i class="fa-solid fa-plane"></i></button>
  <button onclick="nav('wish',this)" class="nav-btn"><i class="fa-solid fa-gift"></i></button>
</nav>

<script>
// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const firebaseConfig = {
  apiKey: "AIzaSyCBZ96lSFIWzPsHklwk3ZU8kfWudfp8oVQ",
  authDomain: "samcy-1136c.firebaseapp.com",
  projectId: "samcy-1136c",
  storageBucket: "samcy-1136c.firebasestorage.app",
  messagingSenderId: "337821844780",
  appId: "1:337821844780:web:4a31a07928e36a1f5a5889"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// â”€â”€ AUTH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let user = localStorage.getItem('jp_user');
if (user) {
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('u-display').innerText = user.charAt(0).toUpperCase() + user.slice(1);
  document.getElementById('u-dot').style.background = user === 'jade' ? 'var(--jade-color)' : 'var(--phileas-color)';
}
window.login = (name) => {
  user = name;
  localStorage.setItem('jp_user', user);
  document.getElementById('login-screen').classList.add('hidden');
  document.getElementById('u-display').innerText = name.charAt(0).toUpperCase() + name.slice(1);
  document.getElementById('u-dot').style.background = name === 'jade' ? 'var(--jade-color)' : 'var(--phileas-color)';
  initAll();
};
window.logout = () => { localStorage.removeItem('jp_user'); location.reload(); };

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.nav = (p, btn) => {
  document.querySelectorAll('.page').forEach(x => x.classList.remove('active'));
  document.getElementById(p).classList.add('active');
  document.querySelectorAll('.nav-btn').forEach(x => x.classList.remove('active'));
  btn.classList.add('active');
};

// â”€â”€ IMAGE COMPRESSION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let imgs = {};
window.compress = (inp, key) => {
  const file = inp.files[0]; if (!file) return;
  const reader = new FileReader(); reader.readAsDataURL(file);
  reader.onload = (e) => {
    const img = new Image(); img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const maxW = 400; const scale = maxW / img.width;
      canvas.width = maxW; canvas.height = img.height * scale;
      canvas.getContext('2d').drawImage(img, 0, 0, canvas.width, canvas.height);
      const data = canvas.toDataURL('image/jpeg', 0.6);
      imgs[key] = data;
      const vids = { wish: 'v-w', p1: 'v-p1', p2: 'v-p2' };
      const tids = { wish: 'txt-w', p1: 'txt-p1', p2: 'txt-p2' };
      if (vids[key]) {
        const el = document.getElementById(vids[key]);
        el.style.backgroundImage = `url(${data})`; el.style.display = 'block';
        document.getElementById(tids[key]).style.display = 'none';
      }
    };
  };
};

// â”€â”€ MOOD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.setMood = (e, btn) => {
  db.collection('jp_moods').doc(user).set({ e });
  btn.parentNode.querySelectorAll('button').forEach(b => b.classList.remove('selected'));
  btn.classList.add('selected');
};
db.collection('jp_moods').onSnapshot(s => {
  s.forEach(d => {
    const el = document.getElementById('m-' + d.id);
    if (el) el.innerText = d.data().e;
  });
});

// â”€â”€ CALENDAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const now = new Date();
const monthNames = ["Janvier","FÃ©vrier","Mars","Avril","Mai","Juin","Juillet","AoÃ»t","Septembre","Octobre","Novembre","DÃ©cembre"];
document.getElementById('cal-title').innerText = monthNames[now.getMonth()] + ' ' + now.getFullYear();
const dim = new Date(now.getFullYear(), now.getMonth() + 1, 0).getDate();
const startDay = new Date(now.getFullYear(), now.getMonth(), 1).getDay();
const shift = startDay === 0 ? 6 : startDay - 1;
const calGrid = document.getElementById('cal-grid');
calGrid.innerHTML = '';
for (let k = 0; k < shift; k++) calGrid.innerHTML += '<div></div>';
for (let i = 1; i <= dim; i++) {
  const dStr = `${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${i.toString().padStart(2,'0')}`;
  const isToday = i === now.getDate();
  calGrid.innerHTML += `<div onclick="selD('${dStr}')" class="cal-day${isToday?' today':''} cursor-pointer" id="day-${dStr}">${i}</div>`;
}
db.collection('jp_events').onSnapshot(s => {
  document.querySelectorAll('.has-event').forEach(e => e.classList.remove('has-event'));
  s.forEach(d => {
    const el = document.getElementById(`day-${d.data().d}`);
    if (el) el.classList.add('has-event');
  });
});
window.selD = (d) => {
  document.getElementById('evt-box').classList.remove('hidden');
  document.getElementById('sel-date').innerText = d;
  db.collection('jp_events').where('d', '==', d).onSnapshot(s => {
    const l = document.getElementById('evt-list'); l.innerHTML = '';
    s.forEach(doc => {
      l.innerHTML += `<div style="display:flex;justify-content:space-between;align-items:center;background:#F8F6F2;padding:8px 12px;border-radius:10px;margin-bottom:6px;font-size:12px;font-weight:600;color:var(--ink-soft)"><span>${doc.data().t}</span><button onclick="del('jp_events','${doc.id}')" style="color:#D0CBC4;background:none;border:none;cursor:pointer;font-size:16px">Ã—</button></div>`;
    });
  });
};
window.addEvt = () => {
  const t = document.getElementById('new-evt').value;
  const d = document.getElementById('sel-date').innerText;
  if (t) { db.collection('jp_events').add({ t, d }); document.getElementById('new-evt').value = ''; }
};

// Countdown
db.collection('jp_events').onSnapshot(s => {
  const today = new Date(); today.setHours(0,0,0,0); let arr = [];
  s.forEach(d => { const ev = d.data(); const dt = new Date(ev.d); if (dt >= today) arr.push({ ...ev, obj: dt }); });
  if (arr.length) {
    arr.sort((a, b) => a.obj - b.obj);
    const diff = Math.ceil((arr[0].obj - today) / (1000*60*60*24));
    document.getElementById('countdown').classList.remove('hidden');
    document.getElementById('next-t').innerText = arr[0].t;
    document.getElementById('next-j').innerText = diff;
    document.getElementById('next-d').innerText = `Le ${arr[0].d}`;
  }
});

// â”€â”€ ACTIVITIES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const actIcons = { Resto:'ğŸ', FastFood:'ğŸ”', Bar:'ğŸ¸', Expo:'ğŸ–¼', Musique:'ğŸµ', Sport:'ğŸƒ', Autre:'âœ¨' };
const actColors = { Resto:'#FFE9E9', FastFood:'#FFF6D6', Bar:'#E8DEFF', Expo:'#D8F2EA', Musique:'#D6EAFA', Sport:'#DCFAEE', Autre:'#EAF5F0' };
window.addAct = () => {
  const n = document.getElementById('act-name').value;
  const c = document.getElementById('act-cat').value;
  const l = document.getElementById('act-loc').value;
  if (n) {
    db.collection('jp_acts').add({ n, c, l, done: false, rating: 0, review: '', addedBy: user });
    document.getElementById('act-name').value = ''; document.getElementById('act-loc').value = '';
  }
};

let allActs = []; let curActFilter = 'all';
db.collection('jp_acts').onSnapshot(s => {
  allActs = []; s.forEach(d => allActs.push({ id: d.id, ...d.data() }));
  renderActs();
});

window.filterAct = (f, el) => {
  curActFilter = f;
  document.querySelectorAll('#act-chips .chip').forEach(c => c.classList.remove('active-chip'));
  el.classList.add('active-chip');
  renderActs();
};

function renderActs() {
  const l = document.getElementById('act-list'); l.innerHTML = '';
  let filtered = curActFilter === 'all' ? allActs
    : curActFilter === 'done' ? allActs.filter(a => a.done)
    : allActs.filter(a => a.c === curActFilter && !a.done || (curActFilter === 'done' && a.done));
  if (curActFilter !== 'all' && curActFilter !== 'done') filtered = allActs.filter(a => a.c === curActFilter);

  filtered.forEach(a => {
    const stars = [1,2,3,4,5].map(s => `<span onclick="updAct('${a.id}',{rating:${s}})" class="star" style="color:${s<=a.rating?'#F5C842':'#DDD'}">${s<=a.rating?'â˜…':'â˜†'}</span>`).join('');
    l.innerHTML += `
    <div class="activity-card ${a.done?'done':''}" style="flex-direction:column;align-items:stretch">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:${a.done?'10px':'0'}">
        <div class="act-icon" style="background:${actColors[a.c]||'#F5F3F0'}">${actIcons[a.c]||'âœ¨'}</div>
        <div class="act-info">
          <div class="act-name">${a.n}</div>
          <div class="act-loc">${a.l||''}${a.addedBy?` Â· par ${a.addedBy}`:''}</div>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-end;gap:6px">
          ${a.done?'<span class="act-done-badge">âœ“ Fait</span>':''}
          <label style="display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;color:var(--muted);cursor:pointer">
            <input type="checkbox" ${a.done?'checked':''} onchange="updAct('${a.id}',{done:this.checked})" style="accent-color:var(--sage);width:16px;height:16px">
          </label>
        </div>
        <button onclick="del('jp_acts','${a.id}')" style="color:#DDD;background:none;border:none;cursor:pointer;font-size:18px;flex-shrink:0">Ã—</button>
      </div>
      ${a.done?`
      <div style="background:#F8F6F2;border-radius:12px;padding:10px 12px;display:flex;flex-direction:column;gap:8px">
        <div class="stars">${stars}</div>
        <input type="text" value="${a.review||''}" onchange="updAct('${a.id}',{review:this.value})" placeholder="Ton avis..." style="background:white;border:1px solid #EEE;border-radius:8px;padding:8px;font-size:12px;font-family:'DM Sans',sans-serif;outline:none;color:var(--ink)">
      </div>`:''
    }
    </div>`;
  });

  if (!filtered.length) l.innerHTML = '<p style="text-align:center;color:var(--muted);font-size:13px;padding:30px 0;font-weight:500">Rien ici pour l\'instant ğŸŒ¿</p>';
}
window.updAct = (id, data) => db.collection('jp_acts').doc(id).update(data);

// â”€â”€ JOURNAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addJournal = () => {
  const t = document.getElementById('jnl-text').value.trim();
  if (t) {
    const d = new Date();
    const dateStr = d.toLocaleDateString('fr-FR', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
    db.collection('jp_journal').add({ t, u: user, date: dateStr, ts: Date.now() });
    document.getElementById('jnl-text').value = '';
  }
};
db.collection('jp_journal').orderBy('ts', 'desc').onSnapshot(s => {
  const l = document.getElementById('jnl-list'); l.innerHTML = '';
  s.forEach(doc => {
    const d = doc.data(); const mine = d.u === user;
    l.innerHTML += `
    <div class="journal-entry ${mine?'journal-mine':'journal-theirs'}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <span style="font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:${mine?'var(--sage)':'var(--terracotta)'}">${d.u === 'jade' ? 'ğŸ‘©ğŸ»â€ğŸ¦° Jade' : 'ğŸ‘±ğŸ»â€â™‚ï¸ Phileas'}</span>
        <div style="display:flex;gap:8px;align-items:center">
          <span style="font-size:10px;color:var(--muted)">${d.date||''}</span>
          ${mine?`<button onclick="del('jp_journal','${doc.id}')" style="color:#DDD;background:none;border:none;cursor:pointer;font-size:16px">Ã—</button>`:''}
        </div>
      </div>
      <p style="font-size:13px;color:var(--ink-soft);line-height:1.6">${d.t}</p>
    </div>`;
  });
});

// â”€â”€ CHAT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.sendMsg = () => {
  const t = document.getElementById('msg').value.trim();
  if (t) { db.collection('jp_chat').add({ type:'txt', t, u:user, time:Date.now() }); document.getElementById('msg').value = ''; }
};
window.sendPoll = () => {
  const q = document.getElementById('pq').value.trim();
  const opt1 = document.getElementById('poll-opt1').value.trim();
  const opt2 = document.getElementById('poll-opt2').value.trim();
  if (!q) { alert("Ajoute une question !"); return; }
  const label1 = opt1 || 'Option 1';
  const label2 = opt2 || 'Option 2';
  db.collection('jp_chat').add({ 
    type:'poll', q, 
    i1: imgs.p1||'', i2: imgs.p2||'', 
    label1, label2,
    v1:0, v2:0, u:user, time:Date.now() 
  });
  document.getElementById('poll-modal').classList.add('hidden');
  document.getElementById('pq').value = '';
  document.getElementById('poll-opt1').value = '';
  document.getElementById('poll-opt2').value = '';
  imgs = {};
  document.getElementById('v-p1').style.display='none'; document.getElementById('txt-p1').style.display='';
  document.getElementById('v-p2').style.display='none'; document.getElementById('txt-p2').style.display='';
};
window.votePoll = (id, side) => {
  const ref = db.collection('jp_chat').doc(id);
  db.runTransaction(tx => tx.get(ref).then(doc => { if(doc.exists) tx.update(ref, { [side]: (doc.data()[side]||0)+1 }); }));
};
db.collection('jp_chat').orderBy('time').onSnapshot(s => {
  const l = document.getElementById('chat-box'); l.innerHTML = '';
  s.forEach(doc => {
    const d = doc.data(); const mine = d.u === user;
    if (d.type === 'txt') {
      const color = d.u === 'jade' ? 'var(--sage)' : 'var(--terracotta)';
      l.innerHTML += `<div style="display:flex;flex-direction:column;align-items:${mine?'flex-end':'flex-start'}">
        <span style="font-size:9px;font-weight:700;color:${color};margin-bottom:2px;${mine?'text-align:right':''}; text-transform:uppercase;letter-spacing:1px">${!mine?(d.u==='jade'?'ğŸ‘©ğŸ»â€ğŸ¦° Jade':'ğŸ‘±ğŸ»â€â™‚ï¸ Phileas'):''}</span>
        <div class="msg-bubble ${mine?'msg-mine':'msg-theirs'}">${d.t}</div>
      </div>`;
    } else {
      const total = (d.v1||0)+(d.v2||0);
      const p1 = total === 0 ? 0 : Math.round((d.v1/total)*100);
      const p2 = total === 0 ? 0 : Math.round((d.v2/total)*100);
      const lbl1 = d.label1 || 'Option 1';
      const lbl2 = d.label2 || 'Option 2';
      const hasImg1 = d.i1 && d.i1.length > 0;
      const hasImg2 = d.i2 && d.i2.length > 0;
      l.innerHTML += `<div class="card" style="margin-bottom:10px">
        <p style="font-size:11px;font-weight:700;color:var(--sage);text-transform:uppercase;letter-spacing:1px;margin-bottom:10px">ğŸ“Š ${d.q}</p>
        <div style="display:flex;gap:8px">
          <div onclick="votePoll('${doc.id}','v1')" class="poll-opt">
            ${hasImg1 ? `<div style="height:90px;background:url('${d.i1}');background-size:cover;background-position:center;border-radius:12px;border:1px solid rgba(0,0,0,0.05)"></div>` : `<div style="height:60px;background:#D8F2EA;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--sage);border:2px solid rgba(91,160,138,0.2)">${lbl1}</div>`}
            <div style="display:flex;justify-content:space-between;margin-top:6px"><span style="font-size:10px;font-weight:700;color:var(--ink-soft)">${d.v1||0} votes</span><span style="font-size:10px;font-weight:700;color:var(--sage)">${p1}%</span></div>
            ${hasImg1 ? `<div style="font-size:11px;font-weight:600;color:var(--ink-soft);margin-top:2px;text-align:center">${lbl1}</div>` : ''}
          </div>
          <div onclick="votePoll('${doc.id}','v2')" class="poll-opt">
            ${hasImg2 ? `<div style="height:90px;background:url('${d.i2}');background-size:cover;background-position:center;border-radius:12px;border:1px solid rgba(0,0,0,0.05)"></div>` : `<div style="height:60px;background:#D6EAFA;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:var(--terracotta);border:2px solid rgba(107,159,212,0.2)">${lbl2}</div>`}
            <div style="display:flex;justify-content:space-between;margin-top:6px"><span style="font-size:10px;font-weight:700;color:var(--ink-soft)">${d.v2||0} votes</span><span style="font-size:10px;font-weight:700;color:var(--terracotta)">${p2}%</span></div>
            ${hasImg2 ? `<div style="font-size:11px;font-weight:600;color:var(--ink-soft);margin-top:2px;text-align:center">${lbl2}</div>` : ''}
          </div>
        </div>
      </div>`;
    }
  });
  l.scrollTop = l.scrollHeight;
});

// â”€â”€ VACANCES / CAGNOTTE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.editSave = () => {
  const v = prompt("Montant Ã  ajouter ou retirer (ex: +200 ou -50) :");
  if (v) {
    const r = prompt("Motif ?") || '?';
    const cur = parseInt(document.getElementById('tot-save').innerText) || 0;
    db.collection('jp_stats').doc('cagnotte').set({ t: cur + parseInt(v) });
    db.collection('jp_hist').add({ v, r, d: Date.now() });
  }
};
db.collection('jp_stats').doc('cagnotte').onSnapshot(d => {
  if (d.exists) {
    document.getElementById('tot-save').innerText = d.data().t + ' â‚¬';
    document.getElementById('trip-cagnotte').innerText = d.data().t + ' â‚¬';
  }
});
db.collection('jp_hist').orderBy('d','desc').limit(15).onSnapshot(s => {
  const l = document.getElementById('hist-save'); l.innerHTML = '';
  s.forEach(doc => {
    const d = doc.data(); const v = parseInt(d.v); const c = v > 0 ? '#7A9E7E' : '#C17B5A';
    l.innerHTML += `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.08);font-size:10px"><span style="color:rgba(248,244,238,0.7);font-weight:600;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${d.r}</span><span style="color:${c};font-weight:800;margin-left:8px">${d.v}â‚¬</span><button onclick="delHist('${doc.id}',${v})" style="color:rgba(255,255,255,0.3);background:none;border:none;cursor:pointer;margin-left:8px;font-size:12px">Ã—</button></div>`;
  });
});
window.delHist = (id, val) => {
  if (confirm("Supprimer ? Le total sera ajustÃ©.")) {
    db.collection('jp_hist').doc(id).delete();
    const cur = parseInt(document.getElementById('tot-save').innerText) || 0;
    db.collection('jp_stats').doc('cagnotte').set({ t: cur - val });
  }
};

// â”€â”€ DESTINATIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addDest = () => {
  const dest = document.getElementById('vac-dest').value;
  const budget = document.getElementById('vac-budget').value;
  const period = document.getElementById('vac-period').value;
  if (dest) {
    db.collection('jp_dests').add({ dest, budget: budget||'?', period: period||'', priority: Date.now(), addedBy: user });
    document.getElementById('vac-dest').value = ''; document.getElementById('vac-budget').value = ''; document.getElementById('vac-period').value = '';
  }
};

let allDests = [];
db.collection('jp_dests').orderBy('priority').onSnapshot(s => {
  allDests = []; s.forEach(d => allDests.push({ id: d.id, ...d.data() }));
  renderDests();
});

function renderDests() {
  const l = document.getElementById('dest-list'); l.innerHTML = '';
  allDests.forEach((d, i) => {
    l.innerHTML += `
    <div class="vac-card" draggable="true" id="dest-${d.id}" ondragstart="dragStart(event,'${d.id}')" ondragover="event.preventDefault()" ondrop="dragDrop(event,'${d.id}')">
      <div style="display:flex;align-items:center;gap:12px">
        <div class="priority-badge">${i+1}</div>
        <div style="flex:1">
          <div style="font-weight:700;font-size:14px;color:var(--ink)">${d.dest}</div>
          <div style="font-size:11px;color:var(--muted);margin-top:2px">
            ${d.budget !== '?' ? `ğŸ’¶ ~${d.budget}â‚¬ estimÃ©` : 'ğŸ’¶ Budget Ã  dÃ©finir'} 
            ${d.period ? ` Â· ğŸ“… ${d.period}` : ''}
          </div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <div style="display:flex;flex-direction:column;gap:4px">
            <button onclick="moveDest('${d.id}',-1)" ${i===0?'disabled':''} style="background:none;border:none;cursor:pointer;color:var(--muted);font-size:14px;opacity:${i===0?'0.3':'1'}">â–²</button>
            <button onclick="moveDest('${d.id}',1)" ${i===allDests.length-1?'disabled':''} style="background:none;border:none;cursor:pointer;color:var(--muted);font-size:14px;opacity:${i===allDests.length-1?'0.3':'1'}">â–¼</button>
          </div>
          <button onclick="del('jp_dests','${d.id}')" style="color:#DDD;background:none;border:none;cursor:pointer;font-size:18px">Ã—</button>
        </div>
      </div>
    </div>`;
  });
}

window.moveDest = (id, dir) => {
  const idx = allDests.findIndex(d => d.id === id);
  const newIdx = idx + dir;
  if (newIdx < 0 || newIdx >= allDests.length) return;
  const batch = db.batch();
  batch.update(db.collection('jp_dests').doc(allDests[idx].id), { priority: allDests[newIdx].priority });
  batch.update(db.collection('jp_dests').doc(allDests[newIdx].id), { priority: allDests[idx].priority });
  batch.commit();
};

// Drag & drop
let dragId = null;
window.dragStart = (e, id) => { dragId = id; e.currentTarget.classList.add('dragging'); };
window.dragDrop = (e, targetId) => {
  e.preventDefault();
  document.querySelectorAll('.vac-card').forEach(c => c.classList.remove('dragging'));
  if (dragId === targetId) return;
  const from = allDests.find(d => d.id === dragId);
  const to = allDests.find(d => d.id === targetId);
  if (!from || !to) return;
  const batch = db.batch();
  batch.update(db.collection('jp_dests').doc(from.id), { priority: to.priority });
  batch.update(db.collection('jp_dests').doc(to.id), { priority: from.priority });
  batch.commit();
};

// â”€â”€ TRIP PLANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addTripLine = () => {
  const form = document.getElementById('trip-activities-form');
  const div = document.createElement('div');
  div.className = 'trip-act-row';
  div.style.cssText = 'display:flex;gap:8px;margin-bottom:6px';
  div.innerHTML = `<input type="text" placeholder="ActivitÃ©" class="inp trip-act-name" style="flex:1;margin:0"><input type="number" placeholder="â‚¬" class="inp trip-act-price" style="width:70px;margin:0"><button onclick="this.parentNode.remove();recalcTrip()" style="background:none;border:none;cursor:pointer;color:#DDD;font-size:18px">Ã—</button>`;
  form.appendChild(div);
  div.querySelector('.trip-act-price').addEventListener('input', recalcTrip);
};
function recalcTrip() {
  const prices = Array.from(document.querySelectorAll('.trip-act-price')).map(p => parseFloat(p.value)||0);
  const total = prices.reduce((a,b)=>a+b, 0);
  document.getElementById('trip-total').classList.remove('hidden');
  document.getElementById('trip-total-amount').innerText = total + ' â‚¬';
  const dest = document.getElementById('trip-dest').value;
  document.getElementById('trip-total-dest').innerText = dest || 'â€”';
  const cagnotte = parseInt(document.getElementById('tot-save').innerText) || 0;
  const diff = cagnotte - total;
  document.getElementById('trip-diff').innerText = diff >= 0 ? `âœ… Il reste ${diff}â‚¬ aprÃ¨s ce voyage` : `âš ï¸ Il manque ${Math.abs(diff)}â‚¬`;
}
document.querySelectorAll('.trip-act-price').forEach(el => el.addEventListener('input', recalcTrip));

window.calcAndSaveTrip = () => {
  const dest = document.getElementById('trip-dest').value;
  const date = document.getElementById('trip-date').value;
  if (!dest) { alert("Ajoute une destination !"); return; }
  const rows = Array.from(document.querySelectorAll('.trip-act-row'));
  const activities = rows.map(r => ({
    name: r.querySelector('.trip-act-name').value,
    price: parseFloat(r.querySelector('.trip-act-price').value) || 0
  })).filter(a => a.name);
  const total = activities.reduce((s, a) => s + a.price, 0);
  db.collection('jp_trips').add({ dest, date, activities, total, createdBy: user, ts: Date.now() });
  document.getElementById('trip-dest').value = ''; document.getElementById('trip-date').value = '';
  document.getElementById('trip-activities-form').innerHTML = `<div class="trip-act-row" style="display:flex;gap:8px;margin-bottom:6px"><input type="text" placeholder="ActivitÃ©" class="inp trip-act-name" style="flex:1;margin:0"><input type="number" placeholder="â‚¬" class="inp trip-act-price" style="width:70px;margin:0"></div>`;
  document.getElementById('trip-total').classList.add('hidden');
};

db.collection('jp_trips').orderBy('ts','desc').onSnapshot(s => {
  const l = document.getElementById('trips-list'); l.innerHTML = '';
  s.forEach(doc => {
    const d = doc.data();
    const lines = (d.activities||[]).map(a => `<div class="trip-line"><span style="font-size:12px;font-weight:600;color:var(--ink-soft)">${a.name}</span><span style="font-size:12px;font-weight:700;color:var(--terracotta)">${a.price}â‚¬</span></div>`).join('');
    const cagnotte = parseInt(document.getElementById('tot-save').innerText) || 0;
    const diff = cagnotte - d.total;
    l.innerHTML += `
    <div class="card" style="margin-bottom:12px">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:10px">
        <div><h3 style="font-family:'DM Serif Display',serif;font-size:18px;color:var(--ink)">${d.dest}</h3><p style="font-size:11px;color:var(--muted);margin-top:2px">${d.date||'Dates Ã  dÃ©finir'}</p></div>
        <button onclick="del('jp_trips','${doc.id}')" style="color:#DDD;background:none;border:none;cursor:pointer;font-size:18px">Ã—</button>
      </div>
      ${lines}
      <div class="trip-total">
        <div><p style="font-size:10px;opacity:0.8;font-weight:600">Total estimÃ©</p><p style="font-family:'DM Serif Display',serif;font-size:26px">${d.total}â‚¬</p></div>
        <div style="text-align:right"><p style="font-size:10px;opacity:0.8;font-weight:600">Cagnotte</p><p style="font-size:18px;font-weight:800">${cagnotte}â‚¬</p><p style="font-size:10px;opacity:0.7;margin-top:2px">${diff>=0?'âœ… On peut y aller':'âš ï¸ Il manque '+(Math.abs(diff))+'â‚¬'}</p></div>
      </div>
    </div>`;
  });
});

// â”€â”€ WISHLIST â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addWish = () => {
  const n = document.getElementById('w-n').value;
  const p = document.getElementById('w-p').value;
  const l = document.getElementById('w-l').value;
  const i = imgs.wish || '';
  if (n) {
    db.collection('jp_wish').add({ n, p, l, i, u: user });
    document.getElementById('w-n').value = ''; document.getElementById('w-p').value = '';
    document.getElementById('w-l').value = ''; imgs.wish = '';
    document.getElementById('v-w').style.display = 'none';
    document.getElementById('txt-w').style.display = '';
  }
};

let wishFilter = 'all';
window.filterWish = (f) => {
  wishFilter = f;
  ['all','jade','phileas'].forEach(x => {
    const btn = document.getElementById('wf-' + x);
    if (x === f) { btn.style.background = 'var(--ink)'; btn.style.color = 'white'; }
    else { btn.style.background = '#F5F3F0'; btn.style.color = x==='jade'?'var(--sage)':x==='phileas'?'var(--terracotta)':'var(--muted)'; }
  });
  renderWish();
};

let allWish = [];
db.collection('jp_wish').onSnapshot(s => {
  allWish = []; s.forEach(d => allWish.push({ id: d.id, ...d.data() }));
  renderWish();
});

function renderWish() {
  const g = document.getElementById('w-grid'); g.innerHTML = '';
  const filtered = wishFilter === 'all' ? allWish : allWish.filter(w => w.u === wishFilter);
  filtered.forEach(w => {
    const tagClass = w.u === 'jade' ? 'wish-tag-jade' : 'wish-tag-phileas';
    g.innerHTML += `
    <div class="wish-item">
      <div class="wish-img" style="background-image:url('${w.i||''}')${!w.i?';background-color:#F5F3F0;background-image:none;display:flex;align-items:center;justify-content:center;':''}">
        ${!w.i?'<span style="font-size:30px">ğŸ</span>':''}
      </div>
      <div class="wish-body">
        <div class="wish-name">${w.n}</div>
        ${w.p?`<div class="wish-price">${w.p}â‚¬</div>`:''}
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:4px">
          <span class="${tagClass}">${w.u}</span>
          ${w.l?`<a href="${w.l}" target="_blank" style="font-size:10px;color:var(--muted);text-decoration:underline;font-weight:600">Voir</a>`:''}
        </div>
        <button onclick="del('jp_wish','${w.id}')" style="position:absolute;top:4px;right:4px;background:rgba(255,255,255,0.9);border:none;border-radius:50%;width:22px;height:22px;color:#C17B5A;cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center">Ã—</button>
      </div>
    </div>`;
  });
  if (!filtered.length) g.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:var(--muted);font-size:13px;padding:30px 0;font-weight:500">Rien ici encore ğŸ</p>';
}

// â”€â”€ DELETE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.del = (c, id) => { if (confirm("Supprimer ?")) db.collection(c).doc(id).delete(); };

// init
function initAll() {}
</script>
</body>
</html>